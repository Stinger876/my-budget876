<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monarch-Lite v13.9</title>
    <style>
        :root { --m-blue: #0a192f; --m-teal: #17e9e1; --m-bg: #121212; --m-card: #1e1e1e; --m-red: #ff5252; --m-green: #2ecc71; --m-text: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--m-bg); margin: 0; padding: 10px; color: var(--m-text); padding-bottom: 80px; }
        
        #startup-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; }
        .modal-card { background: var(--m-card); padding: 30px; border-radius: 24px; border: 1px solid var(--m-teal); width: 85%; max-width: 400px; text-align: center; }
        
        .budget-header { background: var(--m-green); color: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; }
        .header-main { display: flex; justify-content: space-between; font-weight: 800; font-size: 1.1rem; }
        .card { background: var(--m-card); padding: 15px; border-radius: 16px; margin-bottom: 15px; }
        
        .budget-row { display: grid; grid-template-columns: 1fr 70px 70px 25px; gap: 8px; align-items: center; padding: 12px 0; border-bottom: 1px solid #2a2a2a; }
        .budget-label { font-size: 18px; font-weight: bold; margin: 20px 0 8px 0; display: flex; justify-content: space-between; }
        .col-head { font-size: 10px; opacity: 0.5; text-transform: uppercase; text-align: right; font-weight: 800; }
        
        .bar-container { height: 4px; background: #333; border-radius: 2px; margin-top: 6px; width: 100%; overflow: hidden; grid-column: 1 / 4; }
        .bar-progress { height: 100%; background: var(--m-green); transition: width 0.3s; }
        .bar-over { background: var(--m-red); }

        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #333; background: #2a2a2a; color: white; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        .btn-add-small { background: #2a2a2a; color: var(--m-teal); border: 1px solid var(--m-teal); padding: 4px 10px; border-radius: 6px; font-size: 10px; cursor: pointer; font-weight: bold; }
        .btn-track { width: 100%; padding: 16px; background: var(--m-teal); color: var(--m-blue); border-radius: 12px; border: none; font-weight: 800; text-transform: uppercase; margin-top: 10px; cursor: pointer;}
        .del-btn { color: var(--m-red); background: none; border: none; font-size: 18px; cursor: pointer; text-align: right; padding: 0;}
        
        .val-pos { color: var(--m-green); font-weight: 600; text-align: right; }
        .val-neg { color: var(--m-red); font-weight: 600; text-align: right; }
        .val-neutral { color: white; text-align: right; }
    </style>
</head>
<body>

    <div id="startup-modal">
        <div class="modal-card">
            <h2 style="color:var(--m-teal); margin-top:0;">Restore Data?</h2>
            <p style="opacity:0.7; font-size:14px; margin-bottom:20px;">Open your <b>budget_working_copy.json</b> to load your current plan.</p>
            <label for="sync-upload" style="background:var(--m-teal); color:var(--m-blue); padding:15px; border-radius:12px; font-weight:bold; cursor:pointer; display:block; margin-bottom:10px;">Yes, Open File</label>
            <div style="background:#333; padding:15px; border-radius:12px; font-weight:bold; cursor:pointer;" onclick="closeModal()">No, Start Fresh</div>
        </div>
    </div>

    <div class="budget-header">
        <div class="header-main">
            <span>Left to budget</span>
            <span id="header-remaining">$0</span>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; font-size:11px;">
            <div id="sync-status">Sync: Never</div>
            <div style="display:flex; gap:12px;">
                <label for="sync-upload" style="cursor:pointer; font-weight:bold;">â†‘ SYNC</label>
                <div onclick="exportNewFile()" style="cursor:pointer; font-weight:bold;">â†“ SAVE</div>
            </div>
            <input type="file" id="sync-upload" accept=".json" style="display:none" onchange="syncFromFile(event)">
        </div>
    </div>

    <div class="budget-label"><span>Income</span><button class="btn-add-small" onclick="promptPlan('inc')">+ ADD</button></div>
    <div class="card">
        <div class="budget-row" style="border-bottom: 2px solid #333;">
            <span class="col-head" style="text-align:left">Category</span><span class="col-head">Budget</span><span class="col-head">Remaining</span><span></span>
        </div>
        <div id="income-list"></div>
    </div>

    <div class="budget-label"><span>Expenses</span><button class="btn-add-small" onclick="promptPlan('exp')">+ ADD</button></div>
    <div class="card">
        <div class="budget-row" style="border-bottom: 2px solid #333;">
            <span class="col-head" style="text-align:left">Category</span><span class="col-head">Budget</span><span class="col-head">Remaining</span><span></span>
        </div>
        <div id="expense-list"></div>
    </div>

    <div class="card">
        <b>Track Transaction</b>
        <input type="text" id="desc" placeholder="Merchant (e.g. Starbucks)">
        <select id="cat">
            <option value="" disabled selected>Select Category</option>
            <optgroup label="Planned Income" id="opt-inc"></optgroup>
            <optgroup label="Planned Expenses" id="opt-exp"></optgroup>
            <optgroup label="Other">
                <option value="General Income">ðŸ’° General Income</option>
                <option value="General Expense">ðŸ’³ General Expense</option>
            </optgroup>
        </select>
        <div style="display:flex; gap:10px;">
            <input type="date" id="txn-date" style="flex:1">
            <input type="text" inputmode="decimal" id="amt" placeholder="Amount" style="flex:1">
        </div>
        <button class="btn-track" onclick="addTransaction()">Add Entry</button>
    </div>

    <h3 style="margin-left:10px;">Recent Activity</h3>
    <div id="txn-list"></div>

    <script>
        let txns = JSON.parse(localStorage.getItem('m9_txns')) || [];
        let planInc = JSON.parse(localStorage.getItem('m9_p_inc')) || [];
        let planExp = JSON.parse(localStorage.getItem('m9_p_exp')) || [];

        window.onload = function() {
            document.getElementById('startup-modal').style.display = 'flex';
            document.getElementById('txn-date').valueAsDate = new Date();
            updateUI();
        };

        function closeModal() { document.getElementById('startup-modal').style.display = 'none'; }

        function syncFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.txns) {
                        txns = data.txns; planInc = data.planInc || []; planExp = data.planExp || [];
                        localStorage.setItem('m9_last_sync', data.exportedAt || new Date().toLocaleString());
                    }
                    saveAndRefresh(); closeModal();
                } catch (err) { alert("Invalid File"); }
            };
            reader.readAsText(file);
        }

        function exportNewFile() {
            const bundle = { txns, planInc, planExp, version: "13.9", exportedAt: new Date().toLocaleString() };
            const blob = new Blob([JSON.stringify(bundle, null, 2)], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "budget_working_copy.json";
            link.click();
        }

        function promptPlan(type) {
            const name = prompt("Name (e.g. Hydro):");
            const amt = parseFloat(prompt("Budget Amount:"));
            if (name && !isNaN(amt)) {
                if (type === 'inc') planInc.push({ id: Date.now(), name, amt });
                else planExp.push({ id: Date.now(), name, amt });
                saveAndRefresh();
            }
        }

        function addTransaction() {
            const desc = document.getElementById('desc').value;
            const cat = document.getElementById('cat').value;
            const date = document.getElementById('txn-date').value;
            let amt = parseFloat(document.getElementById('amt').value);
            
            if(!desc || !cat || isNaN(amt)) return;
            
            // Income logic: Checks if cat is a planned income or "General Income"
            const isInc = planInc.some(p => p.name === cat) || cat === "General Income";
            amt = isInc ? Math.abs(amt) : -Math.abs(amt);

            txns.unshift({ id: Date.now(), desc, cat, date, amt });
            document.getElementById('desc').value = ''; 
            document.getElementById('amt').value = '';
            saveAndRefresh();
        }

        function deleteItem(type, id) {
            if(type === 'txn') txns = txns.filter(t => t.id !== id);
            if(type === 'inc') planInc = planInc.filter(i => i.id !== id);
            if(type === 'exp') planExp = planExp.filter(e => e.id !== id);
            saveAndRefresh();
        }

        function saveAndRefresh() {
            localStorage.setItem('m9_txns', JSON.stringify(txns));
            localStorage.setItem('m9_p_inc', JSON.stringify(planInc));
            localStorage.setItem('m9_p_exp', JSON.stringify(planExp));
            updateUI();
        }

        function updateUI() {
            const incList = document.getElementById('income-list');
            const expList = document.getElementById('expense-list');
            const txnList = document.getElementById('txn-list');
            const optInc = document.getElementById('opt-inc');
            const optExp = document.getElementById('opt-exp');
            
            incList.innerHTML = ''; expList.innerHTML = ''; txnList.innerHTML = ''; 
            optInc.innerHTML = ''; optExp.innerHTML = '';
            
            planInc.forEach(p => optInc.innerHTML += `<option value="${p.name}">ðŸ“ˆ ${p.name}</option>`);
            planExp.forEach(p => optExp.innerHTML += `<option value="${p.name}">ðŸ’¸ ${p.name}</option>`);

            let totalPlannedInc = 0;
            let actualSpendingTotal = 0;
            let actualIncomeTotal = 0;

            const renderSection = (planArr, targetEl, isExp) => {
                planArr.forEach(p => {
                    if(!isExp) totalPlannedInc += p.amt;
                    
                    const actual = txns.filter(t => t.cat === p.name)
                                       .reduce((sum, t) => sum + Math.abs(t.amt), 0);

                    const remaining = p.amt - actual;
                    const pct = Math.min((actual / p.amt) * 100, 100) || 0;
                    const colorClass = isExp ? (remaining < 0 ? 'val-neg' : 'val-pos') : 'val-pos';

                    targetEl.innerHTML += `
                        <div class="budget-row">
                            <span style="font-weight:600">${p.name}</span>
                            <span class="val-neutral">$${p.amt.toLocaleString()}</span>
                            <span class="${colorClass}">$${remaining.toLocaleString()}</span>
                            <button class="del-btn" onclick="deleteItem('${isExp?'exp':'inc'}', ${p.id})">Ã—</button>
                            <div class="bar-container">
                                <div class="bar-progress ${isExp && remaining < 0 ? 'bar-over' : ''}" style="width:${pct}%"></div>
                            </div>
                        </div>`;
                });
            };

            renderSection(planInc, incList, false);
            renderSection(planExp, expList, true);

            // Calculate overall header totals
            txns.forEach(t => {
                if(t.amt < 0) actualSpendingTotal += Math.abs(t.amt);
                else actualIncomeTotal += t.amt;
            });

            // "Left to budget" = Planned Income - Actual Spending
            const leftToBudget = totalPlannedInc - actualSpendingTotal;
            document.getElementById('header-remaining').innerText = `$${leftToBudget.toLocaleString()}`;
            document.getElementById('sync-status').innerText = "Sync: " + (localStorage.getItem('m9_last_sync') || "Never");

            txns.slice(0, 20).forEach(t => {
                const d = new Date(t.date + 'T00:00:00').toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                txnList.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding:12px;">
                    <div><b>${t.cat}</b><br><small>${t.desc} â€¢ ${d}</small></div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <b style="${t.amt < 0 ? 'color:var(--m-red)' : 'color:var(--m-teal)'}">$${Math.abs(t.amt).toLocaleString()}</b>
                        <button class="del-btn" onclick="deleteItem('txn', ${t.id})">Ã—</button>
                    </div>
                </div>`;
            });
        }
    </script>
</body>
</html>
